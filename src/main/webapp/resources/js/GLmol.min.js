THREE.ShaderLib.lambert.fragmentShader=THREE.ShaderLib.lambert.fragmentShader.replace("gl_FrontFacing","true");THREE.ShaderLib.lambert.vertexShader=THREE.ShaderLib.lambert.vertexShader.replace(/\}$/,"#ifdef DOUBLE_SIDED\n if (transformedNormal.z < 0.0) vLightFront = vLightBack;\n #endif\n }");var TV3=THREE.Vector3,TF3=THREE.Face3,TCo=THREE.Color;THREE.Geometry.prototype.colorAll=function(a){for(var b=0;b<this.faces.length;b++){this.faces[b].color=a}};THREE.Matrix4.prototype.isIdentity=function(){for(var b=0;b<4;b++){for(var a=0;a<4;a++){if(this.elements[b*4+a]!=(b==a)?1:0){return false}}}return true};var GLmol=(function(){function a(e,b,d){if(e){this.create(e,b,d)}return true}a.prototype.create=function(h,d,f){this.Nucleotides=["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU"];this.ElementColors={H:13421772,C:11184810,O:13369344,N:204,S:13421568,P:6693580,F:52224,CL:52224,BR:8921600,I:6684842,FE:13395456,CA:8947882};this.vdwRadii={H:1.2,Li:1.82,Na:2.27,K:2.75,C:1.7,N:1.55,O:1.52,F:1.47,P:1.8,S:1.8,CL:1.75,BR:1.85,SE:1.9,ZN:1.39,CU:1.4,NI:1.63};this.id=h;this.aaScale=1;this.container=$("#"+this.id);this.WIDTH=this.container.width()*this.aaScale,this.HEIGHT=this.container.height()*this.aaScale;this.ASPECT=this.WIDTH/this.HEIGHT;this.NEAR=1,FAR=800;this.CAMERA_Z=-150;this.webglFailed=true;try{if(f){throw"WebGL disabled"}this.renderer=new THREE.WebGLRenderer({antialias:true});this.renderer.sortObjects=false;this.renderer.domElement.style.width="100%";this.renderer.domElement.style.height="100%";this.container.append(this.renderer.domElement);this.renderer.setSize(this.WIDTH,this.HEIGHT);this.webglFailed=false}catch(g){this.canvas2d=$("<canvas></canvas");this.container.append(this.canvas2d);this.canvas2d[0].height=this.HEIGHT;this.canvas2d[0].width=this.WIDTH}this.camera=new THREE.PerspectiveCamera(20,this.ASPECT,1,800);this.camera.position=new TV3(0,0,this.CAMERA_Z);this.camera.lookAt(new TV3(0,0,0));this.perspectiveCamera=this.camera;this.orthoscopicCamera=new THREE.OrthographicCamera();this.orthoscopicCamera.position.z=this.CAMERA_Z;this.orthoscopicCamera.lookAt(new TV3(0,0,0));var b=this;$(window).resize(function(){b.WIDTH=b.container.width()*b.aaScale;b.HEIGHT=b.container.height()*b.aaScale;if(!b.webglFailed){b.ASPECT=b.WIDTH/b.HEIGHT;b.renderer.setSize(b.WIDTH,b.HEIGHT);b.camera.aspect=b.ASPECT;b.camera.updateProjectionMatrix()}else{b.canvas2d[0].height=b.HEIGHT;b.canvas2d[0].width=b.WIDTH}b.show()});this.scene=null;this.rotationGroup=null;this.modelGroup=null;this.bgColor=0;this.fov=20;this.fogStart=0.4;this.slabNear=-50;this.slabFar=+50;this.sphereRadius=1.5;this.cylinderRadius=0.4;this.lineWidth=1.5*this.aaScale;this.curveWidth=3*this.aaScale;this.defaultColor=13421772;this.sphereQuality=16;this.cylinderQuality=16;this.axisDIV=5;this.strandDIV=6;this.nucleicAcidStrandDIV=4;this.tubeDIV=8;this.coilWidth=0.3;this.helixSheetWidth=1.3;this.nucleicAcidWidth=0.8;this.thickness=0.4;this.cq=new THREE.Quaternion(1,0,0,0);this.dq=new THREE.Quaternion(1,0,0,0);this.isDragging=false;this.mouseStartX=0;this.mouseStartY=0;this.currentModelPos=0;this.cz=0;this.enableMouse();if(d){return}this.loadMolecule()};a.prototype.setupLights=function(e){var d=new THREE.DirectionalLight(16777215);d.position=new TV3(0.2,0.2,-1).normalize();d.intensity=1.2;e.add(d);var b=new THREE.AmbientLight(2105376);e.add(b)};a.prototype.parseSDF=function(l){var j=this.atoms;var g=this.protein;var p=l.split("\n");if(p.length<4){return}var b=parseInt(p[3].substr(0,3));if(isNaN(b)||b<=0){return}var d=parseInt(p[3].substr(3,3));var f=4;if(p.length<4+b+d){return}for(var h=1;h<=b;h++){var o=p[f];f++;var k={};k.serial=h;k.x=parseFloat(o.substr(0,10));k.y=parseFloat(o.substr(10,10));k.z=parseFloat(o.substr(20,10));k.hetflag=true;k.atom=k.elem=o.substr(31,3).replace(/ /g,"");k.bonds=[];k.bondOrder=[];j[h]=k}for(h=1;h<=d;h++){var o=p[f];f++;var n=parseInt(o.substr(0,3));var m=parseInt(o.substr(3,3));var e=parseInt(o.substr(6,3));j[n].bonds.push(m);j[n].bondOrder.push(e);j[m].bonds.push(n);j[m].bondOrder.push(e)}g.smallMolecule=true;return true};a.prototype.parseXYZ=function(m){var h=this.atoms;var f=this.protein;var n=m.split("\n");if(n.length<3){return}var b=parseInt(n[0].substr(0,3));if(isNaN(b)||b<=0){return}if(n.length<b+2){return}var e=2;for(var g=1;g<=b;g++){var o=n[e++];var l=o.replace(/^\s+/,"").replace(/\s+/g," ").split(" ");console.log(l);var k={};k.serial=g;k.atom=k.elem=l[0];k.x=parseFloat(l[1]);k.y=parseFloat(l[2]);k.z=parseFloat(l[3]);k.hetflag=true;k.bonds=[];k.bondOrder=[];h[g]=k}for(var g=1;g<b;g++){for(var d=g+1;d<=b;d++){if(this.isConnected(h[g],h[d])){h[g].bonds.push(d);h[g].bondOrder.push(1);h[d].bonds.push(g);h[d].bondOrder.push(1)}}}f.smallMolecule=true;return true};a.prototype.parsePDB2=function(E){var k=this.atoms;var J=this.protein;var N;var g=0;lines=E.split("\n");for(var I=0;I<lines.length;I++){line=lines[I].replace(/^\s*/,"");var M=line.substr(0,6);if(M=="ATOM  "||M=="HETATM"){var e,C,w,H,q,p,o,t,K,l,s,L;s=line.substr(16,1);if(s!=" "&&s!="A"){continue}l=parseInt(line.substr(6,5));e=line.substr(12,4).replace(/ /g,"");C=line.substr(17,3);w=line.substr(21,1);H=parseInt(line.substr(22,5));q=parseFloat(line.substr(30,8));p=parseFloat(line.substr(38,8));o=parseFloat(line.substr(46,8));L=parseFloat(line.substr(60,8));K=line.substr(76,2).replace(/ /g,"");if(K==""){K=line.substr(12,4).replace(/ /g,"")}if(line[0]=="H"){t=true}else{t=false}k[l]={resn:C,x:q,y:p,z:o,elem:K,hetflag:t,chain:w,resi:H,serial:l,atom:e,bonds:[],ss:"c",color:16777215,bonds:[],bondOrder:[],b:L}}else{if(M=="SHEET "){var v=line.substr(21,1);var d=parseInt(line.substr(22,4));var r=line.substr(32,1);var B=parseInt(line.substr(33,4));J.sheet.push([v,d,r,B])}else{if(M=="CONECT"){var F=parseInt(line.substr(6,5));for(var G=0;G<4;G++){var f=parseInt(line.substr([11,16,21,26][G],5));if(isNaN(f)){continue}if(k[F]!=undefined){k[F].bonds.push(f);k[F].bondOrder.push(1)}}}else{if(M=="HELIX "){var v=line.substr(19,1);var d=parseInt(line.substr(21,4));var r=line.substr(31,1);var B=parseInt(line.substr(33,4));J.helix.push([v,d,r,B])}else{if(M=="CRYST1"){J.a=parseFloat(line.substr(6,9));J.b=parseFloat(line.substr(15,9));J.c=parseFloat(line.substr(24,9));J.alpha=parseFloat(line.substr(33,7));J.beta=parseFloat(line.substr(40,7));J.gamma=parseFloat(line.substr(47,7));J.spacegroup=line.substr(55,11);this.defineCell()}else{if(M=="REMARK"){var h=parseInt(line.substr(7,3));if(h==290&&line.substr(13,5)=="SMTRY"){var A=parseInt(line[18])-1;var D=parseInt(line.substr(21,2));if(J.symMat[D]==undefined){J.symMat[D]=new THREE.Matrix4().identity()}J.symMat[D].elements[A]=parseFloat(line.substr(24,9));J.symMat[D].elements[A+4]=parseFloat(line.substr(34,9));J.symMat[D].elements[A+8]=parseFloat(line.substr(44,9));J.symMat[D].elements[A+12]=parseFloat(line.substr(54,10))}else{if(h==350&&line.substr(13,5)=="BIOMT"){var A=parseInt(line[18])-1;var D=parseInt(line.substr(21,2));if(J.biomtMatrices[D]==undefined){J.biomtMatrices[D]=new THREE.Matrix4().identity()}J.biomtMatrices[D].elements[A]=parseFloat(line.substr(24,9));J.biomtMatrices[D].elements[A+4]=parseFloat(line.substr(34,9));J.biomtMatrices[D].elements[A+8]=parseFloat(line.substr(44,9));J.biomtMatrices[D].elements[A+12]=parseFloat(line.substr(54,10))}else{if(h==350&&line.substr(11,11)=="BIOMOLECULE"){J.biomtMatrices=[];J.biomtChains=""}else{if(h==350&&line.substr(34,6)=="CHAINS"){J.biomtChains+=line.substr(41,40)}}}}}else{if(M=="HEADER"){J.pdbID=line.substr(62,4)}else{if(M=="TITLE "){if(J.title==undefined){J.title=""}J.title+=line.substr(10,70)+"\n"}else{if(M=="COMPND"){}}}}}}}}}}for(I=0;I<k.length;I++){e=k[I];if(e==undefined){continue}var u=false;for(G=0;G<J.sheet.length;G++){if(e.chain!=J.sheet[G][0]){continue}if(e.resi<J.sheet[G][1]){continue}if(e.resi>J.sheet[G][3]){continue}e.ss="s";if(e.resi==J.sheet[G][1]){e.ssbegin=true}if(e.resi==J.sheet[G][3]){e.ssend=true}}for(G=0;G<J.helix.length;G++){if(e.chain!=J.helix[G][0]){continue}if(e.resi<J.helix[G][1]){continue}if(e.resi>J.helix[G][3]){continue}e.ss="h";if(e.resi==J.helix[G][1]){e.ssbegin=true}else{if(e.resi==J.helix[G][3]){e.ssend=true}}}}J.smallMolecule=false;return true};a.prototype.subdivide=function(k,r){var w=[];var u=k;u=new Array();u.push(k[0]);for(var v=1,l=k.length-1;v<l;v++){var e=k[v],d=k[v+1];if(e.smoothen){u.push(new TV3((e.x+d.x)/2,(e.y+d.y)/2,(e.z+d.z)/2))}else{u.push(e)}}u.push(k[k.length-1]);for(var v=-1,q=u.length;v<=q-3;v++){var f=u[(v==-1)?0:v];var e=u[v+1],d=u[v+2];var b=u[(v==q-3)?q-1:v+3];var h=new TV3().sub(d,f).multiplyScalar(0.5);var g=new TV3().sub(b,e).multiplyScalar(0.5);for(var s=0;s<r;s++){var p=1/r*s;var o=e.x+p*h.x+p*p*(-3*e.x+3*d.x-2*h.x-g.x)+p*p*p*(2*e.x-2*d.x+h.x+g.x);var n=e.y+p*h.y+p*p*(-3*e.y+3*d.y-2*h.y-g.y)+p*p*p*(2*e.y-2*d.y+h.y+g.y);var m=e.z+p*h.z+p*p*(-3*e.z+3*d.z-2*h.z-g.z)+p*p*p*(2*e.z-2*d.z+h.z+g.z);w.push(new TV3(o,n,m))}}w.push(u[u.length-1]);return w};a.prototype.drawAtomsAsSphere=function(n,m,l,e,h){var f=new THREE.SphereGeometry(1,this.sphereQuality,this.sphereQuality);for(var j=0;j<m.length;j++){var k=this.atoms[m[j]];if(k==undefined){continue}var d=new THREE.MeshLambertMaterial({color:k.color});var g=new THREE.Mesh(f,d);n.add(g);var b=(!e&&this.vdwRadii[k.elem]!=undefined)?this.vdwRadii[k.elem]:l;if(!e&&h){b*=h}g.scale.x=g.scale.y=g.scale.z=b;g.position.x=k.x;g.position.y=k.y;g.position.z=k.z}};a.prototype.drawAtomsAsIcosahedron=function(k,j,h,b){var e=this.IcosahedronGeometry();for(var f=0;f<j.length;f++){var g=this.atoms[j[f]];if(g==undefined){continue}var l=new THREE.MeshLambertMaterial({color:g.color});var d=new THREE.Mesh(e,l);d.scale.x=d.scale.y=d.scale.z=(!b&&this.vdwRadii[g.elem]!=undefined)?this.vdwRadii[g.elem]:h;k.add(d);d.position.x=g.x;d.position.y=g.y;d.position.z=g.z}};a.prototype.isConnected=function(e,b){var f=e.bonds.indexOf(b.serial);if(f!=-1){return e.bondOrder[f]}if(this.protein.smallMolecule&&(e.hetflag||b.hetflag)){return 0}var d=(e.x-b.x)*(e.x-b.x)+(e.y-b.y)*(e.y-b.y)+(e.z-b.z)*(e.z-b.z);if(isNaN(d)){return 0}if(d<0.5){return 0}if(d>1.3&&(e.elem=="H"||b.elem=="H"||e.elem=="D"||b.elem=="D")){return 0}if(d<3.42&&(e.elem=="S"||b.elem=="S")){return 1}if(d>2.78){return 0}return 1};a.prototype.drawBondAsStickSub=function(m,h,f,b,e){var l,j;if(e>1){l=this.calcBondDelta(h,f,b*2.3)}var n=new TV3(h.x,h.y,h.z);var k=new TV3(f.x,f.y,f.z);var d=n.clone().addSelf(k).multiplyScalar(0.5);var i=new TCo(h.color),g=new TCo(f.color);if(e==1||e==3){this.drawCylinder(m,n,d,b,h.color);this.drawCylinder(m,k,d,b,f.color)}if(e>1){j=d.clone().addSelf(l);this.drawCylinder(m,n.clone().addSelf(l),j,b,h.color);this.drawCylinder(m,k.clone().addSelf(l),j,b,f.color);j=d.clone().subSelf(l);this.drawCylinder(m,n.clone().subSelf(l),j,b,h.color);this.drawCylinder(m,k.clone().subSelf(l),j,b,f.color)}};a.prototype.drawBondsAsStick=function(k,n,f,s,h,d,v){var t=new THREE.SphereGeometry(1,this.sphereQuality,this.sphereQuality);var u=n.length,o;var g=[];if(!!d){f/=2.5}for(var e=0;e<u;e++){var r=n[e];var m=this.atoms[r];if(m==undefined){continue}for(var b=e+1;b<e+30&&b<u;b++){var q=n[b];var l=this.atoms[q];if(l==undefined){continue}var p=this.isConnected(m,l);if(p==0){continue}m.connected=l.connected=true;this.drawBondAsStickSub(k,m,l,f,(!!d)?p:1)}for(var b=0;b<m.bonds.length;b++){var q=m.bonds[b];if(q<r+30){continue}if(n.indexOf(q)==-1){continue}var l=this.atoms[q];if(l==undefined){continue}m.connected=l.connected=true;this.drawBondAsStickSub(k,m,l,f,(!!d)?m.bondOrder[b]:1)}if(m.connected){g.push(r)}}this.drawAtomsAsSphere(k,g,s,!v,v)};a.prototype.defineCell=function(){var b=this.protein;if(b.a==undefined){return}b.ax=b.a;b.ay=0;b.az=0;b.bx=b.b*Math.cos(Math.PI/180*b.gamma);b.by=b.b*Math.sin(Math.PI/180*b.gamma);b.bz=0;b.cx=b.c*Math.cos(Math.PI/180*b.beta);b.cy=b.c*(Math.cos(Math.PI/180*b.alpha)-Math.cos(Math.PI/180*b.gamma)*Math.cos(Math.PI/180*b.beta)/Math.sin(Math.PI/180*b.gamma));b.cz=Math.sqrt(b.c*b.c*Math.sin(Math.PI/180*b.beta)*Math.sin(Math.PI/180*b.beta)-b.cy*b.cy)};a.prototype.drawUnitcell=function(k){var j=this.protein;if(j.a==undefined){return}var e=[[0,0,0],[j.ax,j.ay,j.az],[j.bx,j.by,j.bz],[j.ax+j.bx,j.ay+j.by,j.az+j.bz],[j.cx,j.cy,j.cz],[j.cx+j.ax,j.cy+j.ay,j.cz+j.az],[j.cx+j.bx,j.cy+j.by,j.cz+j.bz],[j.cx+j.ax+j.bx,j.cy+j.ay+j.by,j.cz+j.az+j.bz]];var d=[0,1,0,2,1,3,2,3,4,5,4,6,5,7,6,7,0,4,1,5,2,6,3,7];var h=new THREE.Geometry();for(var f=0;f<d.length;f++){h.vertices.push(new TV3(e[d[f]][0],e[d[f]][1],e[d[f]][2]))}var g=new THREE.LineBasicMaterial({linewidth:1,color:13421772});var b=new THREE.Line(h,g);b.type=THREE.LinePieces;k.add(b)};a.prototype.calcBondDelta=function(f,e,l){var b;var d=new TV3(f.x-e.x,f.y-e.y,f.z-e.z).normalize();var k=null;for(var h=0;h<f.bonds.length&&!k;h++){var j=this.atoms[f.bonds[h]];if(!j){continue}if(j.serial!=e.serial&&j.elem!="H"){k=j}}for(var h=0;h<e.bonds.length&&!k;h++){var j=this.atoms[e.bonds[h]];if(!j){continue}if(j.serial!=f.serial&&j.elem!="H"){k=j}}if(k){var g=new TV3(f.x-k.x,f.y-k.y,f.z-k.z).normalize();b=g.dot(d);delta=new TV3(g.x-d.x*b,g.y-d.y*b,g.z-d.z*b)}if(!k||Math.abs(b-1)<0.001||Math.abs(b+1)<0.001){if(d.x<0.01&&d.y<0.01){delta=new TV3(0,-d.z,d.y)}else{delta=new TV3(-d.y,d.x,0)}}delta.normalize().multiplyScalar(l);return delta};a.prototype.drawBondsAsLineSub=function(i,g,e,d){var m,j,o=i.vertices,k=i.colors;if(d>1){m=this.calcBondDelta(g,e,0.15)}var n=new TV3(g.x,g.y,g.z);var l=new TV3(e.x,e.y,e.z);var b=n.clone().addSelf(l).multiplyScalar(0.5);var h=new TCo(g.color),f=new TCo(e.color);if(d==1||d==3){o.push(n);k.push(h);o.push(b);k.push(h);o.push(l);k.push(f);o.push(b);k.push(f)}if(d>1){o.push(n.clone().addSelf(m));k.push(h);o.push(j=b.clone().addSelf(m));k.push(h);o.push(l.clone().addSelf(m));k.push(f);o.push(j);k.push(f);o.push(n.clone().subSelf(m));k.push(h);o.push(j=b.clone().subSelf(m));k.push(h);o.push(l.clone().subSelf(m));k.push(f);o.push(j);k.push(f)}};a.prototype.drawBondsAsLine=function(q,p,o){var m=new THREE.Geometry();var b=p.length;for(var k=0;k<b;k++){var n=p[k];var l=this.atoms[n];if(l==undefined){continue}for(var g=k+1;g<k+30&&g<b;g++){var h=p[g];var f=this.atoms[h];if(f==undefined){continue}var e=this.isConnected(l,f);if(e==0){continue}this.drawBondsAsLineSub(m,l,f,e)}for(var g=0;g<l.bonds.length;g++){var h=l.bonds[g];if(h<n+30){continue}if(p.indexOf(h)==-1){continue}var f=this.atoms[h];if(f==undefined){continue}this.drawBondsAsLineSub(m,l,f,l.bondOrder[g])}}var d=new THREE.LineBasicMaterial({linewidth:o});d.vertexColors=true;var r=new THREE.Line(m,d);r.type=THREE.LinePieces;q.add(r)};a.prototype.drawSmoothCurve=function(k,g,e,b,d){if(g.length==0){return}d=(d==undefined)?5:d;var h=new THREE.Geometry();var l=this.subdivide(g,d);for(var j=0;j<l.length;j++){h.vertices.push(l[j]);h.colors.push(new TCo(b[(j==0)?0:Math.round((j-1)/d)]))}var f=new THREE.LineBasicMaterial({linewidth:e});f.vertexColors=true;var m=new THREE.Line(h,f);m.type=THREE.LineStrip;k.add(m)};a.prototype.drawAsCross=function(n,l,m){var f=new THREE.Geometry();var o=[[m,0,0],[-m,0,0],[0,m,0],[0,-m,0],[0,0,m],[0,0,-m]];for(var g=0,d=l.length;g<d;g++){var h=this.atoms[l[g]];if(h==undefined){continue}var k=new TCo(h.color);for(var e=0;e<6;e++){f.vertices.push(new TV3(h.x+o[e][0],h.y+o[e][1],h.z+o[e][2]));f.colors.push(k)}}var b=new THREE.LineBasicMaterial({linewidth:this.lineWidth});b.vertexColors=true;var p=new THREE.Line(f,b,THREE.LinePieces);n.add(p)};a.prototype.drawSmoothTube=function(k,d,l,p){if(d.length<2){return}var x=this.tubeDIV,h=this.axisDIV;var H=new THREE.Geometry();var v=this.subdivide(d,h);var G=new TV3(),F;for(var w=0,e=v.length;w<e;w++){var o,n=(w-1)/h;if(w==0){o=p[0]}else{if(n%1==0){o=p[n]}else{var I=Math.floor(n);var C=n-I;o=p[I]*C+p[I+1]*(1-C)}}var E,D,B;if(w<e-1){E=new TV3().sub(v[w],v[w+1]);D=new TV3(0,-E.z,E.y).normalize().multiplyScalar(o);B=new TV3().cross(E,D).normalize().multiplyScalar(o);if(G.dot(D)<0){D.negate();B.negate()}G=D;F=B}else{D=G;B=F}for(var t=0;t<x;t++){var y=2*Math.PI/x*t;var A=Math.cos(y),m=Math.sin(y);H.vertices.push(new TV3(v[w].x+A*D.x+m*B.x,v[w].y+A*D.y+m*B.y,v[w].z+A*D.z+m*B.z))}}var g=0;for(var w=0,e=v.length-1;w<e;w++){var A=new TCo(l[Math.round((w-1)/h)]);var f=0;var u=new TV3().sub(H.vertices[g],H.vertices[g+x]).lengthSq();var q=new TV3().sub(H.vertices[g],H.vertices[g+x+1]).lengthSq();if(u>q){u=q;f=1}for(var t=0;t<x;t++){H.faces.push(new TF3(g+t,g+(t+f)%x+x,g+(t+1)%x));H.faces.push(new TF3(g+(t+1)%x,g+(t+f)%x+x,g+(t+f+1)%x+x));H.faces[H.faces.length-2].color=A;H.faces[H.faces.length-1].color=A}g+=x}H.computeFaceNormals();H.computeVertexNormals(false);var z=new THREE.MeshLambertMaterial();z.vertexColors=THREE.FaceColors;var b=new THREE.Mesh(H,z);b.doubleSided=true;k.add(b)};a.prototype.drawMainchainCurve=function(m,k,l,j,d){var n=[],b=[];var e,g;if(d==undefined){d=5}for(var f in k){var h=this.atoms[k[f]];if(h==undefined){continue}if((h.atom==j)&&!h.hetflag){if(e!=h.chain||g+1!=h.resi){this.drawSmoothCurve(m,n,l,b,d);n=[];b=[]}n.push(new TV3(h.x,h.y,h.z));b.push(h.color);e=h.chain;g=h.resi}}this.drawSmoothCurve(m,n,l,b,d)};a.prototype.drawMainchainTube=function(m,l,k,j){var n=[],b=[],f=[];var d,g;for(var e in l){var h=this.atoms[l[e]];if(h==undefined){continue}if((h.atom==k)&&!h.hetflag){if(d!=h.chain||g+1!=h.resi){this.drawSmoothTube(m,n,b,f);n=[];b=[];f=[]}n.push(new TV3(h.x,h.y,h.z));if(j==undefined){f.push((h.b>0)?h.b/100:0.3)}else{f.push(j)}b.push(h.color);d=h.chain;g=h.resi}}this.drawSmoothTube(m,n,b,f)};a.prototype.drawStrip=function(r,k,e,t,w,b){if((k.length)<2){return}w=w||this.axisDIV;k=this.subdivide(k,w);e=this.subdivide(e,w);if(!b){return this.drawThinStrip(r,k,e,t,w)}var E=new THREE.Geometry();var z=E.vertices,q=E.faces;var l,m,u,D,n;for(var B=0,o=k.length;B<o;B++){z.push(m=k[B]);z.push(m);z.push(u=e[B]);z.push(u);if(B<o-1){var x=k[B+1].clone().subSelf(k[B]);var h=e[B].clone().subSelf(k[B]);l=h.crossSelf(x).normalize().multiplyScalar(b)}z.push(D=k[B].clone().addSelf(l));z.push(D);z.push(n=e[B].clone().addSelf(l));z.push(n)}var g=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]];for(var B=1,o=k.length;B<o;B++){var p=8*B,y=new TCo(t[Math.round((B-1)/w)]);for(var A=0;A<4;A++){var C=new THREE.Face4(p+g[A][0],p+g[A][1],p+g[A][2],p+g[A][3],undefined,y);q.push(C)}}var s=z.length-8;for(var B=0;B<4;B++){z.push(z[B*2]);z.push(z[s+B*2])}s+=8;q.push(new THREE.Face4(s,s+2,s+6,s+4,undefined,q[0].color));q.push(new THREE.Face4(s+1,s+5,s+7,s+3,undefined,q[q.length-3].color));E.computeFaceNormals();E.computeVertexNormals(false);var v=new THREE.MeshLambertMaterial();v.vertexColors=THREE.FaceColors;var d=new THREE.Mesh(E,v);d.doubleSided=true;r.add(d)};a.prototype.drawThinStrip=function(l,n,m,b,d){var g=new THREE.Geometry();for(var h=0,e=n.length;h<e;h++){g.vertices.push(n[h]);g.vertices.push(m[h])}for(var h=1,e=n.length;h<e;h++){var j=new THREE.Face4(2*h,2*h+1,2*h-1,2*h-2);j.color=new TCo(b[Math.round((h-1)/d)]);g.faces.push(j)}g.computeFaceNormals();g.computeVertexNormals(false);var k=new THREE.MeshLambertMaterial();k.vertexColors=THREE.FaceColors;var o=new THREE.Mesh(g,k);o.doubleSided=true;l.add(o)};a.prototype.IcosahedronGeometry=function(){if(!this.icosahedron){this.icosahedron=new THREE.IcosahedronGeometry(1)}return this.icosahedron};a.prototype.drawCylinder=function(j,h,i,e,d,k){if(!h||!i){return}var l=new TV3().add(h,i).multiplyScalar(0.5);var d=new TCo(d);if(!this.cylinderGeometry){this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,this.cylinderQuality,1,!k);this.cylinderGeometry.faceUvs=[];this.faceVertexUvs=[]}var f=new THREE.MeshLambertMaterial({color:d.getHex()});var g=new THREE.Mesh(this.cylinderGeometry,f);g.position=l;g.lookAt(h);g.updateMatrix();g.matrixAutoUpdate=false;var b=new THREE.Matrix4().makeScale(e,e,h.distanceTo(i));b.rotateX(Math.PI/2);g.matrix.multiplySelf(b);j.add(g)};a.prototype.drawHelixAsCylinder=function(m,k,j){var d=null;var b,g;var e=[],l=[];for(var f in k){var h=this.atoms[k[f]];if(h==undefined||h.hetflag){continue}if((h.ss!="h"&&h.ss!="s")||h.ssend||h.ssbegin){e.push(h.serial)}if(h.ss=="s"){l.push(h.serial)}if(h.atom!="CA"){continue}if(h.ss=="h"&&h.ssend){if(d!=null){this.drawCylinder(m,new TV3(d.x,d.y,d.z),new TV3(h.x,h.y,h.z),j,h.color,true)}d=null}b=h.chain;g=h.resi;if(d==null&&h.ss=="h"&&h.ssbegin){d=h}}if(d!=null){this.drawCylinder(m,new TV3(d.x,d.y,d.z),new TV3(h.x,h.y,h.z),j,h.color)}this.drawMainchainTube(m,e,"CA",0.3);this.drawStrand(m,l,undefined,undefined,true,0,this.helixSheetWidth,false,this.thickness*2)};a.prototype.drawCartoon=function(e,d,f,b){this.drawStrand(e,d,2,undefined,true,undefined,undefined,f,b)};a.prototype.drawStrand=function(h,u,g,s,A,m,o,t,b){g=g||this.strandDIV;s=s||this.axisDIV;m=m||this.coilWidth;t==(t==undefined)?false:t;o=o||this.helixSheetWidth;var C=[];for(var y=0;y<g;y++){C[y]=[]}var n=[];var l,e,p;var r=null,x=null,w=false;for(var B in u){var d=this.atoms[u[B]];if(d==undefined){continue}if((d.atom=="O"||d.atom=="CA")&&!d.hetflag){if(d.atom=="CA"){if(l!=d.chain||e+1!=d.resi){for(var z=0;!b&&z<g;z++){this.drawSmoothCurve(h,C[z],1,n,s)}if(A){this.drawStrip(h,C[0],C[g-1],n,s,b)}var C=[];for(var y=0;y<g;y++){C[y]=[]}n=[];r=null;x=null;w=false}p=new TV3(d.x,d.y,d.z);l=d.chain;e=d.resi;x=d.ss;w=d.ssstart||d.ssend;n.push(d.color)}else{var f=new TV3(d.x,d.y,d.z);f.subSelf(p);f.normalize();f.multiplyScalar((x=="c")?m:o);if(r!=undefined&&f.dot(r)<0){f.negate()}r=f;for(var z=0;z<g;z++){var D=-1+2/(g-1)*z;var q=new TV3(p.x+r.x*D,p.y+r.y*D,p.z+r.z*D);if(!t&&x=="s"){q.smoothen=true}C[z].push(q)}}}}for(var z=0;!b&&z<g;z++){this.drawSmoothCurve(h,C[z],1,n,s)}if(A){this.drawStrip(h,C[0],C[g-1],n,s,b)}};a.prototype.drawNucleicAcidLadderSub=function(k,g,d,b){if(d[0]!=undefined&&d[1]!=undefined&&d[2]!=undefined&&d[3]!=undefined&&d[4]!=undefined&&d[5]!=undefined){var f=k.vertices.length;for(var h=0;h<=5;h++){k.vertices.push(d[h])}k.faces.push(new TF3(f,f+1,f+2));k.faces.push(new TF3(f,f+2,f+3));k.faces.push(new TF3(f,f+3,f+4));k.faces.push(new TF3(f,f+4,f+5));for(var e=k.faces.length-4,l=k.faces.length;e<l;e++){k.faces[e].color=b}}if(d[4]!=undefined&&d[3]!=undefined&&d[6]!=undefined&&d[7]!=undefined&&d[8]!=undefined){var f=k.vertices.length;k.vertices.push(d[4]);k.vertices.push(d[3]);k.vertices.push(d[6]);k.vertices.push(d[7]);k.vertices.push(d[8]);for(var h=0;h<=4;h++){k.colors.push(b)}k.faces.push(new TF3(f,f+1,f+2));k.faces.push(new TF3(f,f+2,f+3));k.faces.push(new TF3(f,f+3,f+4));for(var e=k.faces.length-3,l=k.faces.length;e<l;e++){k.faces[e].color=b}}};a.prototype.drawNucleicAcidLadder=function(o,n){var g=new THREE.Geometry();var h=new THREE.Geometry();var m=["N1","C2","N3","C4","C5","C6","N9","C8","N7"];var b,j,d=new Array(m.length);var e=new TCo(13369344);for(var f in n){var k=this.atoms[n[f]];if(k==undefined||k.hetflag){continue}if(k.resi!=j||k.chain!=b){this.drawNucleicAcidLadderSub(g,h,d,e);d=new Array(m.length)}var l=m.indexOf(k.atom);if(l!=-1){d[l]=new TV3(k.x,k.y,k.z)}if(k.atom=="O3'"){e=new TCo(k.color)}j=k.resi;b=k.chain}this.drawNucleicAcidLadderSub(g,h,d,e);g.computeFaceNormals();var p=new THREE.MeshLambertMaterial();p.vertexColors=THREE.VertexColors;var q=new THREE.Mesh(g,p);q.doubleSided=true;o.add(q)};a.prototype.drawNucleicAcidStick=function(j,h){var d,e,k=null,b=null;for(var f in h){var g=this.atoms[h[f]];if(g==undefined||g.hetflag){continue}if(g.resi!=e||g.chain!=d){if(k!=null&&b!=null){this.drawCylinder(j,new TV3(k.x,k.y,k.z),new TV3(b.x,b.y,b.z),0.3,k.color,true)}k=null;b=null}if(g.atom=="O3'"){k=g}if(g.resn=="  A"||g.resn=="  G"||g.resn==" DA"||g.resn==" DG"){if(g.atom=="N1"){b=g}}else{if(g.atom=="N3"){b=g}}e=g.resi;d=g.chain}if(k!=null&&b!=null){this.drawCylinder(j,new TV3(k.x,k.y,k.z),new TV3(b.x,b.y,b.z),0.3,k.color,true)}};a.prototype.drawNucleicAcidLine=function(l,k){var b,h,d=null,e=null;var f=new THREE.Geometry();for(var g in k){var j=this.atoms[k[g]];if(j==undefined||j.hetflag){continue}if(j.resi!=h||j.chain!=b){if(d!=null&&e!=null){f.vertices.push(new TV3(d.x,d.y,d.z));f.colors.push(new TCo(d.color));f.vertices.push(new TV3(e.x,e.y,e.z));f.colors.push(new TCo(d.color))}d=null;e=null}if(j.atom=="O3'"){d=j}if(j.resn=="  A"||j.resn=="  G"||j.resn==" DA"||j.resn==" DG"){if(j.atom=="N1"){e=j}}else{if(j.atom=="N3"){e=j}}h=j.resi;b=j.chain}if(d!=null&&e!=null){f.vertices.push(new TV3(d.x,d.y,d.z));f.colors.push(new TCo(d.color));f.vertices.push(new TV3(e.x,e.y,e.z));f.colors.push(new TCo(d.color))}var m=new THREE.LineBasicMaterial({linewidth:1,linejoin:false});m.linewidth=1.5;m.vertexColors=true;var n=new THREE.Line(f,m,THREE.LinePieces);l.add(n)};a.prototype.drawCartoonNucleicAcid=function(e,d,f,b){this.drawStrandNucleicAcid(e,d,2,f,true,undefined,b)};a.prototype.drawStrandNucleicAcid=function(h,q,g,o,s,n,b){n=n||this.nucleicAcidWidth;o=o||this.axisDIV;g=g||this.nucleicAcidStrandDIV;var u=[];for(var r=0;r<g;r++){u[r]=[]}var m=[];var l,e,w;var p=null;for(var v in q){var d=this.atoms[q[v]];if(d==undefined){continue}if((d.atom=="O3'"||d.atom=="OP2")&&!d.hetflag){if(d.atom=="O3'"){if(l!=d.chain||e+1!=d.resi){if(w){for(var t=0;t<g;t++){var x=-1+2/(g-1)*t;u[t].push(new TV3(w.x+p.x*x,w.y+p.y*x,w.z+p.z*x))}}if(s){this.drawStrip(h,u[0],u[1],m,o,b)}for(var t=0;!b&&t<g;t++){this.drawSmoothCurve(h,u[t],1,m,o)}var u=[];for(var r=0;r<g;r++){u[r]=[]}m=[];p=null}w=new TV3(d.x,d.y,d.z);l=d.chain;e=d.resi;m.push(d.color)}else{if(!w){p=null;continue}var f=new TV3(d.x,d.y,d.z);f.subSelf(w);f.normalize().multiplyScalar(n);if(p!=undefined&&f.dot(p)<0){f.negate()}p=f;for(var t=0;t<g;t++){var x=-1+2/(g-1)*t;u[t].push(new TV3(w.x+p.x*x,w.y+p.y*x,w.z+p.z*x))}w=null}}}if(w){for(var t=0;t<g;t++){var x=-1+2/(g-1)*t;u[t].push(new TV3(w.x+p.x*x,w.y+p.y*x,w.z+p.z*x))}}if(s){this.drawStrip(h,u[0],u[1],m,o,b)}for(var t=0;!b&&t<g;t++){this.drawSmoothCurve(h,u[t],1,m,o)}};a.prototype.drawDottedLines=function(q,r,f){var h=new THREE.Geometry();var e=0.3;for(var k=0,d=Math.floor(r.length/2);k<d;k++){var t=r[2*k],o=r[2*k+1];var n=o.clone().subSelf(t);var m=n.length();n.normalize().multiplyScalar(e);var l=Math.floor(m/e);for(var g=0;g<l;g++){var b=new TV3(t.x+n.x*g,t.y+n.y*g,t.z+n.z*g);h.vertices.push(b)}if(l%2==1){h.vertices.push(o)}}var s=new THREE.LineBasicMaterial({color:f.getHex()});s.linewidth=2;var u=new THREE.Line(h,s,THREE.LinePieces);q.add(u)};a.prototype.getAllAtoms=function(){var b=[];for(var d in this.atoms){b.push(this.atoms[d].serial)}return b};a.prototype.getHetatms=function(f){var b=[];for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(e.hetflag){b.push(e.serial)}}return b};a.prototype.removeSolvents=function(f){var b=[];for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(e.resn!="HOH"){b.push(e.serial)}}return b};a.prototype.getProteins=function(f){var b=[];for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(!e.hetflag){b.push(e.serial)}}return b};a.prototype.excludeAtoms=function(h,f){var d=[];var b=new Object();for(var g in f){b[f[g]]=true}for(var g in h){var e=h[g];if(!b[e]){d.push(e)}}return d};a.prototype.getSidechains=function(f){var b=[];for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(e.hetflag){continue}if(e.atom=="C"||e.atom=="O"||(e.atom=="N"&&e.resn!="PRO")){continue}b.push(e.serial)}return b};a.prototype.getAtomsWithin=function(g,e){var b=[];for(var d in g){var f=this.atoms[g[d]];if(f==undefined){continue}if(f.x<e[0][0]||f.x>e[1][0]){continue}if(f.y<e[0][1]||f.y>e[1][1]){continue}if(f.z<e[0][2]||f.z>e[1][2]){continue}b.push(f.serial)}return b};a.prototype.getExtent=function(h){var f=ymin=zmin=9999;var b=ymax=zmax=-9999;var g=ysum=zsum=cnt=0;for(var d in h){var e=this.atoms[h[d]];if(e==undefined){continue}cnt++;g+=e.x;ysum+=e.y;zsum+=e.z;f=(f<e.x)?f:e.x;ymin=(ymin<e.y)?ymin:e.y;zmin=(zmin<e.z)?zmin:e.z;b=(b>e.x)?b:e.x;ymax=(ymax>e.y)?ymax:e.y;zmax=(zmax>e.z)?zmax:e.z}return[[f,ymin,zmin],[b,ymax,zmax],[g/cnt,ysum/cnt,zsum/cnt]]};a.prototype.getResiduesById=function(g,e){var b=[];for(var d in g){var f=this.atoms[g[d]];if(f==undefined){continue}if(e.indexOf(f.resi)!=-1){b.push(f.serial)}}return b};a.prototype.getResidueBySS=function(g,e){var b=[];for(var d in g){var f=this.atoms[g[d]];if(f==undefined){continue}if(e.indexOf(f.ss)!=-1){b.push(f.serial)}}return b};a.prototype.getChain=function(h,e){var b=[],g={};e=e.toString();for(var d=0,j=e.length;d<j;d++){g[e.substr(d,1)]=true}for(var d in h){var f=this.atoms[h[d]];if(f==undefined){continue}if(g[f.chain]){b.push(f.serial)}}return b};a.prototype.getNonbonded=function(g,e){var b=[];for(var d in g){var f=this.atoms[g[d]];if(f==undefined){continue}if(f.hetflag&&f.bonds.length==0){b.push(f.serial)}}return b};a.prototype.colorByAtom=function(f,b){for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}var g=b[e.elem];if(g==undefined){g=this.ElementColors[e.elem]}if(g==undefined){g=this.defaultColor}e.color=g}};a.prototype.colorByStructure=function(f,g,b,h){for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(!h&&(e.atom!="CA"||e.hetflag)){continue}if(e.ss[0]=="s"){e.color=b}else{if(e.ss[0]=="h"){e.color=g}}}};a.prototype.colorByBFactor=function(k,j){var d=1000,b=-1000;for(var f in k){var h=this.atoms[k[f]];if(h==undefined){continue}if(h.hetflag){continue}if(j||h.atom=="CA"||h.atom=="O3'"){if(d>h.b){d=h.b}if(b<h.b){b=h.b}}}var l=(b+d)/2;var g=(b-d)/2;if(g<0.01&&g>-0.01){return}for(var f in k){var h=this.atoms[k[f]];if(h==undefined){continue}if(h.hetflag){continue}if(j||h.atom=="CA"||h.atom=="O3'"){var e=new TCo(0);if(h.b<l){e.setHSV(0.667,(l-h.b)/g,1)}else{e.setHSV(0,(h.b-l)/g,1)}h.color=e.getHex()}}};a.prototype.colorByChain=function(f,g){for(var d in f){var e=this.atoms[f[d]];if(e==undefined){continue}if(e.hetflag){continue}if(g||e.atom=="CA"||e.atom=="O3'"){var b=new TCo(0);b.setHSV((e.chain.charCodeAt(0)*5)%17/17,1,0.9);e.color=b.getHex()}}};a.prototype.colorByResidue=function(e,f){for(var b in e){var d=this.atoms[e[b]];if(d==undefined){continue}c=f[d.resn];if(c!=undefined){d.color=c}}};a.prototype.colorAtoms=function(e,f){for(var b in e){var d=this.atoms[e[b]];if(d==undefined){continue}d.color=f}};a.prototype.colorByPolarity=function(j,h,f){var b=["ARG","HIS","LYS","ASP","GLU","SER","THR","ASN","GLN","CYS"];var g=["GLY","PRO","ALA","VAL","LEU","ILE","MET","PHE","TYR","TRP"];var d={};for(var e in b){d[b[e]]=h}for(e in g){d[g[e]]=f}this.colorByResidue(j,d)};a.prototype.colorChainbow=function(h,j){var e=0;var g,d;for(d in h){g=this.atoms[h[d]];if(g==undefined){continue}if((j||g.atom!="CA"||g.atom!="O3'")&&!g.hetflag){e++}}var f=e;e=0;for(d in h){g=this.atoms[h[d]];if(g==undefined){continue}if((j||g.atom!="CA"||g.atom!="O3'")&&!g.hetflag){var b=new TCo(0);b.setHSV(240/360*(1-e/f),1,0.9);g.color=b.getHex();e++}}};a.prototype.drawSymmetryMates2=function(k,l,d){if(d==undefined){return}l.matrixAutoUpdate=false;var g=1;this.protein.appliedMatrix=new THREE.Matrix4();for(var f=0;f<d.length;f++){var e=d[f];if(e==undefined||e.isIdentity()){continue}console.log(e);var h=THREE.SceneUtils.cloneObject(l);h.matrix=e;k.add(h);for(var b=0;b<16;b++){this.protein.appliedMatrix.elements[b]+=e.elements[b]}g++}this.protein.appliedMatrix.multiplyScalar(g)};a.prototype.drawSymmetryMatesWithTranslation2=function(n,q,m){if(m==undefined){return}var d=this.protein;q.matrixAutoUpdate=false;for(var e=0;e<m.length;e++){var o=m[e];if(o==undefined){continue}for(var l=-1;l<=0;l++){for(var k=-1;k<=0;k++){for(var j=-1;j<=0;j++){var f=new THREE.Matrix4().makeTranslation(d.ax*l+d.bx*k+d.cx*j,d.ay*l+d.by*k+d.cy*j,d.az*l+d.bz*k+d.cz*j);var h=o.clone().multiplySelf(f);if(h.isIdentity()){continue}var g=THREE.SceneUtils.cloneObject(q);g.matrix=h;n.add(g)}}}}};a.prototype.defineRepresentation=function(){var d=this.getAllAtoms();var b=this.removeSolvents(this.getHetatms(d));this.colorByAtom(d,{});this.colorByChain(d);this.drawAtomsAsSphere(this.modelGroup,b,this.sphereRadius);this.drawMainchainCurve(this.modelGroup,d,this.curveWidth,"P");this.drawCartoon(this.modelGroup,d,this.curveWidth)};a.prototype.getView=function(){if(!this.modelGroup){return[0,0,0,0,0,0,0,1]}var d=this.modelGroup.position;var b=this.rotationGroup.quaternion;return[d.x,d.y,d.z,this.rotationGroup.position.z,b.x,b.y,b.z,b.w]};a.prototype.setView=function(b){if(!this.modelGroup||!this.rotationGroup){return}this.modelGroup.position.x=b[0];this.modelGroup.position.y=b[1];this.modelGroup.position.z=b[2];this.rotationGroup.position.z=b[3];this.rotationGroup.quaternion.x=b[4];this.rotationGroup.quaternion.y=b[5];this.rotationGroup.quaternion.z=b[6];this.rotationGroup.quaternion.w=b[7];this.show()};a.prototype.setBackground=function(d,b){b=b|1;this.bgColor=d;if(this.renderer){this.renderer.setClearColorHex(d,b)}this.scene.fog.color=new TCo(d)};a.prototype.initializeScene=function(){this.scene=new THREE.Scene();this.scene.fog=new THREE.Fog(this.bgColor,100,200);this.modelGroup=new THREE.Object3D();this.rotationGroup=new THREE.Object3D();this.rotationGroup.useQuaternion=true;this.rotationGroup.quaternion=new THREE.Quaternion(1,0,0,0);this.rotationGroup.add(this.modelGroup);this.scene.add(this.rotationGroup);this.setupLights(this.scene)};a.prototype.zoomInto=function(h,e){var f=this.getExtent(h);var d=new TV3(f[2][0],f[2][1],f[2][2]);if(this.protein.appliedMatrix){d=this.protein.appliedMatrix.multiplyVector3(d)}this.modelGroup.position=d.multiplyScalar(-1);var b=f[1][0]-f[0][0],j=f[1][1]-f[0][1],i=f[1][2]-f[0][2];var g=Math.sqrt(b*b+j*j+i*i);if(g<25){g=25}if(!e){this.slabNear=-g/1.9;this.slabFar=g/3}this.rotationGroup.position.z=g*0.35/Math.tan(Math.PI/180*this.camera.fov/2)-150;this.rotationGroup.quaternion=new THREE.Quaternion(1,0,0,0)};a.prototype.rebuildScene=function(){time=new Date();var b=this.getView();this.initializeScene();this.defineRepresentation();this.setView(b);console.log("builded scene in "+(+new Date()-time)+"ms")};a.prototype.loadMolecule=function(b){this.loadMoleculeStr(b,$("#"+this.id+"_src").val())};a.prototype.loadMoleculeStr=function(f,d){var e=new Date();this.protein={sheet:[],helix:[],biomtChains:"",biomtMatrices:[],symMat:[],pdbID:"",title:""};this.atoms=[];this.parsePDB2(d);if(!this.parseSDF(d)){this.parseXYZ(d)}console.log("parsed in "+(+new Date()-e)+"ms");var g=$("#"+this.id+"_pdbTitle");var b="";if(this.protein.pdbID!=""){b+='<a href="http://www.rcsb.org/pdb/explore/explore.do?structureId='+this.protein.pdbID+'">'+this.protein.pdbID+"</a>"}if(this.protein.title!=""){b+="<br>"+this.protein.title}g.html(b);this.rebuildScene(true);if(f==undefined||!f){this.zoomInto(this.getAllAtoms())}this.show()};a.prototype.setSlabAndFog=function(){var b=this.rotationGroup.position.z-this.camera.position.z;if(b<1){b=1}this.camera.near=b+this.slabNear;if(this.camera.near<1){this.camera.near=1}this.camera.far=b+this.slabFar;if(this.camera.near+1>this.camera.far){this.camera.far=this.camera.near+1}if(this.camera instanceof THREE.PerspectiveCamera){this.camera.fov=this.fov}else{this.camera.right=b*Math.tan(Math.PI/180*this.fov);this.camera.left=-this.camera.right;this.camera.top=this.camera.right/this.ASPECT;this.camera.bottom=-this.camera.top}this.camera.updateProjectionMatrix();this.scene.fog.near=this.camera.near+this.fogStart*(this.camera.far-this.camera.near);this.scene.fog.far=this.camera.far};a.prototype.enableMouse=function(){var d=this,b=$(this.container);b.bind("mousedown touchstart",function(f){f.preventDefault();if(!d.scene){return}var e=f.pageX,g=f.pageY;if(f.originalEvent.targetTouches&&f.originalEvent.targetTouches[0]){e=f.originalEvent.targetTouches[0].pageX;g=f.originalEvent.targetTouches[0].pageY}if(e==undefined){return}d.isDragging=true;d.mouseButton=f.which;d.mouseStartX=e;d.mouseStartY=g;d.cq=d.rotationGroup.quaternion;d.cz=d.rotationGroup.position.z;d.currentModelPos=d.modelGroup.position.clone();d.cslabNear=d.slabNear;d.cslabFar=d.slabFar});b.bind("DOMMouseScroll mousewheel",function(f){f.preventDefault();if(!d.scene){return}var e=(d.rotationGroup.position.z-d.CAMERA_Z)*0.85;if(f.originalEvent.detail){d.rotationGroup.position.z+=e*f.originalEvent.detail/10}else{if(f.originalEvent.wheelDelta){d.rotationGroup.position.z-=e*f.originalEvent.wheelDelta/400}}console.log(f.originalEvent.wheelDelta,f.originalEvent.detail,d.rotationGroup.position.z);d.show()});b.bind("contextmenu",function(e){e.preventDefault()});$("body").bind("mouseup touchend",function(e){d.isDragging=false});b.bind("mousemove touchmove",function(m){m.preventDefault();if(!d.scene){return}if(!d.isDragging){return}var j=0;var k=$("input[name="+d.id+"_mouseMode]:checked");if(k.length>0){j=parseInt(k.val())}var o=m.pageX,l=m.pageY;if(m.originalEvent.targetTouches&&m.originalEvent.targetTouches[0]){o=m.originalEvent.targetTouches[0].pageX;l=m.originalEvent.targetTouches[0].pageY}if(o==undefined){return}var t=(o-d.mouseStartX)/d.WIDTH;var s=(l-d.mouseStartY)/d.HEIGHT;var f=Math.sqrt(t*t+s*s);if(j==3||(d.mouseButton==3&&m.ctrlKey)){d.slabNear=d.cslabNear+t*100;d.slabFar=d.cslabFar+s*100}else{if(j==2||d.mouseButton==3||m.shiftKey){var n=(d.rotationGroup.position.z-d.CAMERA_Z)*0.85;if(n<80){n=80}d.rotationGroup.position.z=d.cz-s*n}else{if(j==1||d.mouseButton==2||m.ctrlKey){var n=(d.rotationGroup.position.z-d.CAMERA_Z)*0.85;if(n<20){n=20}if(d.webglFailed){t*=-1;s*=-1}var h=new TV3(-t*n,-s*n,0);var g=d.rotationGroup.quaternion;var p=new THREE.Quaternion(g.x,g.y,g.z,g.w).inverse().normalize();var e=p.multiplyVector3(h);d.modelGroup.position.x=d.currentModelPos.x+e.x;d.modelGroup.position.y=d.currentModelPos.y+e.y;d.modelGroup.position.z=d.currentModelPos.z+e.z}else{if((j==0||d.mouseButton==1)&&f!=0){var i=Math.sin(f*Math.PI)/f;d.dq.x=Math.cos(f*Math.PI);d.dq.y=0;d.dq.z=i*t;d.dq.w=i*s;d.rotationGroup.quaternion=new THREE.Quaternion(1,0,0,0);d.rotationGroup.quaternion.multiplySelf(d.dq);d.rotationGroup.quaternion.multiplySelf(d.cq)}}}}d.show()})};a.prototype.show=function(){if(!this.scene){return}var b=new Date();this.setSlabAndFog();if(!this.webglFailed){this.renderer.render(this.scene,this.camera)}else{this.render2d()}console.log("rendered in "+(+new Date()-b)+"ms")};a.prototype.render2d=function(){var q=this.canvas2d[0].getContext("2d");this.scene.updateMatrixWorld();q.fillRect(0,0,this.WIDTH,this.HEIGHT);q.save();q.translate(this.WIDTH/2,this.HEIGHT/2);q.scale(30,30);q.lineCap="round";var n=new THREE.Matrix4();n.multiply(this.camera.matrixWorldInverse,this.modelGroup.matrixWorld);var o=Math.PI*2;var b=[];var k=this.atoms;for(var h=0,p=this.atoms.length;h<p;h++){var m=k[h];if(m==undefined){continue}if(m.screen==undefined){m.screen=new THREE.Vector3}m.screen.set(m.x,m.y,m.z);n.multiplyVector3(m.screen);if(!this.webglFailed){m.screen.y*=-1}b.push([false,m.screen.z,h])}for(var h=0,p=this.atoms.length;h<p;h++){var m=k[h];if(m==undefined){continue}for(var g=0,l=m.bonds.length;g<l;g++){var f=k[m.bonds[g]];if(f==undefined){continue}if(m.serial>f.serial){continue}b.push([true,(m.screen.z+f.screen.z)/2,h,m.bonds[g]])}}b.sort(function(i,j){return i[1]-j[1]});for(var h=0,p=b.length;h<p;h++){var m=k[b[h][2]];if(!b[h][0]){q.fillStyle="rgb("+(m.color>>16)+","+(m.color>>8&255)+","+(m.color&255)+")";q.lineWidth=0.03;q.beginPath();q.arc(m.screen.x,m.screen.y,0.4,0,o,true);q.closePath();q.fill();q.strokeStyle="#000000";q.stroke()}else{var f=k[b[h][3]];q.lineWidth=0.3;var e=(m.screen.x+f.screen.x)/2;var d=(m.screen.y+f.screen.y)/2;q.strokeStyle="rgb("+(m.color>>16)+","+(m.color>>8&255)+","+(m.color&255)+")";q.beginPath();q.moveTo(m.screen.x,m.screen.y);q.lineTo(e,d);q.closePath();q.stroke();q.strokeStyle="rgb("+(f.color>>16)+","+(f.color>>8&255)+","+(f.color&255)+")";q.beginPath();q.moveTo(f.screen.x,f.screen.y);q.lineTo(e,d);q.closePath();q.stroke()}}q.restore()};a.prototype.doFunc=function(b){b(this)};return a}());