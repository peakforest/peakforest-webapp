/*
 This file is part of MetExploreViz 

 Copyright Â© 2016 INRA 
 Contact: http://metexplore.toulouse.inra.fr/metexploreViz/doc/contact 
 GNU General Public License Usage 
 This file may be used under the terms of the GNU General Public License version 3.0 as 
 published by the Free Software Foundation and appearing in the file LICENSE included in the 
 packaging of this file. 
 Please review the following information to ensure the GNU General Public License version 3.0 
 requirements will be met: http://www.gnu.org/copyleft/gpl.html. 
 If you are unsure which license is appropriate for your use, please contact us 
 at http://metexplore.toulouse.inra.fr/metexploreViz/doc/contact
 Version: 1.2.0.2 
 Build Date: Mon Nov 21 14:42:33 CET 2016 
 */
metExploreD3.GraphPanel={getHeight:function(a){return d3.select("#"+a).select("#D3viz").style("height")},getWidth:function(a){return d3.select("#"+a).select("#D3viz").style("width")},resizeViz:function(b){var f=metExploreD3.getScaleById(b);if(f!=undefined){d3.select("#metexplore").text("");d3.select("#"+b).select("#D3viz").attr("width",$("#"+b).width());d3.select("#"+b).select("#D3viz").attr("height",$("#"+b).height());d3.select("#"+b).select("#D3viz").select("#foreignObject").attr("transform","translate("+($("#"+b).width()-300)+",100) scale(1)");var a=f.getZoomScale();var e=d3.scale.linear().domain([0,$("#"+b).width()]).range([0,$("#"+b).width()]);var d=d3.scale.linear().domain([$("#"+b).height(),0]).range([$("#"+b).height(),0]);var c=f.getZoom().translate();f.getZoom().x(e).y(d).translate(c).scale(a);d3.select("#"+b).select("#D3viz").select("#brush").call(d3.svg.brush().x(e).y(d).on("brushstart",function(j){document.addEventListener("mousedown",function(l){if(l.button===1){l.stopPropagation();l.preventDefault();l.stopImmediatePropagation()}});var h=d3.select("#"+b).select("#buttonHand").attr("scrollable");_MyThisGraphNode.activePanel=this.parentNode.parentNode.id;var i=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(d3.event.sourceEvent.button!=1&&h!="true"){if(i!=undefined){if(i.isLinked()){var k=_metExploreViz.getSessionById("viz");if(k!=undefined){var g=k.getForce();if(g!=undefined){g.stop()}}}else{var g=i.getForce();if(g!=undefined){g.stop()}}}brushing=true;d3.select("#"+b).select("#brush").classed("hide",false);d3.select("#"+b).select("#D3viz").on("mousedown.zoom",null);nodeBrushed=d3.select("#"+b).select("#graphComponent").selectAll("g.node");nodeBrushed.each(function(l){l.previouslySelected=l.isSelected()})}else{var g=i.getForce();if(g!=undefined){g.stop()}d3.select("#"+b).selectAll("#D3viz").style("cursor","all-scroll");d3.selectAll("#brush").classed("hide",true)}}).on("brushend",function(){if(d3.event.sourceEvent.button!=1&&brushing){var o=d3.event.target.extent();if(o[1][0]-o[0][0]>20||o[1][1]-o[0][1]>20){var l;var o=d3.event.target.extent();var i=metExploreD3.getScaleById(b);var k=i.getZoomScale();var h=metExploreD3.createLoadMask("Selection in progress...",b);if(h!=undefined){metExploreD3.showMask(h);metExploreD3.deferFunction(function(){nodeBrushed.classed("selected",function(v){var u=i.getZoom().x();var t=i.getZoom().y();l=(u(o[0][0])<=u(v.x)&&u(v.x)<u(o[1][0]))&&(t(o[0][1])<=t(v.y)&&t(v.y)<t(o[1][1]));if((v.isSelected()==false&&l==true)||(v.isSelected()==true&&l==false&&!v.previouslySelected)){_MyThisGraphNode.selection(v,b)}return l});metExploreD3.hideMask(h);var r=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(r!=undefined){if(r.isLinked()){var s=_metExploreViz.getSessionById("viz");if(s!=undefined){var p=metExploreD3.GraphNetwork.isAnimated(s.getId());if(p=="true"){var q=s.getForce();if(q!=undefined){if((metExploreD3.GraphNetwork.isAnimated(s.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(s.getId())==null)){q.start()}}}}}else{var q=r.getForce();var p=metExploreD3.GraphNetwork.isAnimated(r.getId());if(p=="true"){var q=r.getForce();if(q!=undefined){if((metExploreD3.GraphNetwork.isAnimated(r.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(r.getId())==null)){q.start()}}}}}brushing=false},100)}}}else{var m=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(m!=undefined){if(m.isLinked()){var j=_metExploreViz.getSessionById("viz");if(j!=undefined){var n=metExploreD3.GraphNetwork.isAnimated(j.getId());if(n=="true"){var g=j.getForce();if(g!=undefined){if((metExploreD3.GraphNetwork.isAnimated(j.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(j.getId())==null)){g.start()}}}}}else{var g=m.getForce();var n=metExploreD3.GraphNetwork.isAnimated(m.getId());if(n=="true"){var g=m.getForce();if(g!=undefined){if(d3.select(metExploreD3.GraphNetwork.isAnimated(m.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(m.getId())==null)){g.start()}}}}}}d3.event.target.clear();d3.select(this).call(d3.event.target);var i=metExploreD3.getScaleById(b);d3.select("#"+b).selectAll("#D3viz").style("cursor","default");d3.select("#"+b).selectAll("#D3viz").call(i.getZoom()).on("dblclick.zoom",null).on("mousedown",null);d3.event.target.extent();d3.selectAll("#brush").classed("hide",false)}));d3.select("#viz").select("#D3viz").select("#logoViz").select("image").attr("x",$("#viz").width()-88).attr("y",$("#viz").height()-70);d3.select("#metexplore").text("MetExploreViz").attr("x",$("#viz").width()-112).attr("y",$("#viz").height()-10)}},resizePanels:function(a){var g=_metExploreViz.getSessionsSet();var i=_metExploreViz.getSessionById(a);var e=$("#"+a).height();var k=$("#"+a).width();d3.select("#"+a).select("#D3viz").select("foreignObject").attr("x",k-300);if(d3.select("#"+a).select("#D3viz").select("#buttonZoomIn")[0][0]!=null&&d3.select("#"+a).select("#D3viz").select("#buttonZoomOut")[0][0]!=null&&d3.select("#"+a).select("#D3viz").select("#buttonHand")[0][0]!=null){var j=d3.select("#"+a).select("#D3viz").select("#buttonZoomIn").attr("x");var d=k-60-j;d3.select("#"+a).select("#D3viz").select("#buttonZoomIn").attr("transform","translate("+d+",0) scale(1)");j=d3.select("#"+a).select("#D3viz").select("#buttonZoomOut").attr("x");d=k-110-j;d3.select("#"+a).select("#D3viz").select("#buttonZoomOut").attr("transform","translate("+d+",0) scale(1)");j=d3.select("#"+a).select("#D3viz").select("#buttonHand").attr("x");d=k-160-j;d3.select("#"+a).select("#D3viz").select("#buttonHand").attr("transform","translate("+d+",0) scale(1)");j=d3.select("#"+a).select("#D3viz").select("#whiteBlack").attr("x");d=k-100-j;d3.select("#"+a).select("#D3viz").select("#whiteBlack").attr("transform","translate("+d+",0) scale(1)");j=d3.select("#"+a).select("#D3viz").select("#invertColor").attr("x");d=k-100-j;d3.select("#"+a).select("#D3viz").select("#invertColor").attr("transform","translate("+d+",0) scale(1)")}if(i!=undefined){if(i.isLinked()){var f=_metExploreViz.getSessionById("viz");var b=f.getForce();if(b!=undefined){var e=$("#viz").height();var k=$("#viz").width();b.size([k,e]);var c=d3.select("#viz").select("#buttonAnim").attr("animation");if(c=="true"){b.resume()}}}else{var b=i.getForce();if(b!=undefined){var e=$("#"+a).height();var k=$("#"+a).width();b.size([k,e]);var c=d3.select("#"+a).select("#buttonAnim").attr("animation");if(c=="true"){b.resume()}}}}var m=_metExploreViz.getSessionsSet();var i=_metExploreViz.getSessionById(a);if(i!=undefined){var c=metExploreD3.GraphNetwork.isAnimated(a);if(c=="true"){if(i.isLinked()){for(var l in m){if(m[l].isLinked()){metExploreD3.GraphNetwork.animationButtonOn(m[l].getId())}}var b=_metExploreViz.getSessionById("viz").getForce();b.resume()}else{metExploreD3.GraphNetwork.animationButtonOn(a);var b=i.getForce();b.resume()}}}},removeSvgComponents:function(a){d3.select("#"+a).select("#D3viz").selectAll("*").remove()},refreshJSON:function(c){var b=metExploreD3.GraphUtils.decodeJSON(c);if(b){if(!_metExploreViz.isLaunched()){metExploreD3.GraphPanel.initiateViz("D3")}var d=Ext.getCmp("viz");if(d!=undefined){var a=metExploreD3.createLoadMask("Refresh in process...","viz");if(a!=undefined){metExploreD3.showMask(a);var e=this;setTimeout(function(){metExploreD3.fireEvent("selectConditionForm","resetMapping");if(b.sessions!=undefined){metExploreD3.GraphPanel.loadDataJSON(c,f)}else{metExploreD3.GraphPanel.initDataJSON(c,f)}function f(){metExploreD3.hideMask(a);metExploreD3.fireEvent("graphPanel","afterrefresh")}},100)}}}},refreshPanel:function(a,c){var b=this;metExploreD3.hideInitialMask();if(metExploreD3.GraphUtils.decodeJSON(a).nodes||metExploreD3.GraphUtils.decodeJSON(a).sessions){if(!_metExploreViz.isLaunched()||metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.GraphPanel.refreshJSON(a);if(typeof c==="function"){c()}}else{Ext.Msg.show({title:"Are you sure?",msg:"This action will remove previous network. <br />Would you like to do this?",buttons:Ext.Msg.OKCANCEL,fn:function(d){if(d=="ok"){metExploreD3.GraphPanel.refreshJSON(a);if(c!=undefined&&typeof c==="function"){c()}}},icon:Ext.Msg.QUESTION})}}else{metExploreD3.displayWarning("Syntaxe error",'File have bad syntax. Use a saved file from MetExploreViz or see <a href="http://metexplore.toulouse.inra.fr/metexploreViz/doc/documentation.php#generalfunctioning">MetExploreViz documentation</a>.')}},loadDataJSON:function(c,a){var b=metExploreD3.GraphUtils.decodeJSON(c);if(b){if(metExploreD3.bioSourceControled()){_metExploreViz.setBiosource(b.biosource);metExploreD3.fireEventParentWebSite("loadNetworkBiosource",{biosource:b.biosource,func:d,endFunc:a,json:c})}else{d();a()}function d(){var m=_metExploreViz.getSessionById("viz");var k=m.getForce();if(k!=undefined){k.nodes([]);k.links([]);k.on("start",null);k.on("end",null);k.on("tick",null)}m.reset();if(b.comparedPanels){b.comparedPanels.forEach(function(q){_metExploreViz.addComparedPanel(new ComparedPanel(q.panel,q.visible,q.parent,q.title))})}if(b.mappings){b.mappings.forEach(function(q){var q=new Mapping(q.name,q.conditions,q.targetLabel);_metExploreViz.addMapping(q)})}if(b.generalStyle){var g=metExploreD3.getGeneralStyle();var f=new GeneralStyle(g.getWebsiteName(),b.generalStyle.colorMinMappingContinuous,b.generalStyle.colorMaxMappingContinuous,b.generalStyle.maxReactionThreshold,b.generalStyle.displayLabelsForOpt,b.generalStyle.displayLinksForOpt,b.generalStyle.displayConvexhulls,b.generalStyle.clustered,b.generalStyle.displayCaption,g.hasEventForNodeInfo(),g.loadButtonIsHidden(),g.windowsAlertIsDisable());metExploreD3.setGeneralStyle(f)}var n=b.sessions;for(var o in n){if(o!="viz"){var m=new NetworkVizSession();m.setVizEngine("D3");m.setId(o);m.setLinked(n[o].linked);_metExploreViz.addSession(m);var l=Ext.getCmp("comparePanel");var i=_metExploreViz.getComparedPanelById(o);var p=[{id:i.getParent(),title:i.getTitle(),html:'<div id="'+i.getParent()+'" height="100%" width="100%"></div>',flex:1,closable:true,collapsible:true,collapseDirection:"left"}];l.add(p);l.expand();metExploreD3.fireEventArg("comparePanel","initiateviz",o)}if(n[o].colorMappings){n[o].colorMappings.forEach(function(q){m.addColorMapping(q.name,q.value)})}var j=n[o].animated;if(!j){j=false}m.setAnimated(j);var h=new NetworkData(o);h.cloneObject(n[o].d3Data);var e=h.getNodes();e.forEach(function(q){if(q.getBiologicalType()=="metabolite"){if(h.getCompartmentByName(q.getCompartment())==null){h.addCompartment(q.getCompartment())}}else{q.getPathways().forEach(function(r){if(h.getPathwayByName(r)==null){h.addPathway(r)}})}if(q.getMappingDatasLength()>0){q.getMappingDatas().forEach(function(r){r.setNode(q);if(_metExploreViz.getMappingByName(r.getMappingName())!=null){var s=_metExploreViz.getMappingByName(r.getMappingName());s.addMap(r)}})}});h.setId(o);if(o=="viz"){_metExploreViz.setInitialData(_metExploreViz.cloneNetworkData(h))}m.setD3Data(h);if(n[o].selectedNodes){n[o].selectedNodes.forEach(function(q){m.addSelectedNode(q)})}if(_metExploreViz.getMappingsLength()>0&&o=="viz"&&!metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.displayMessageYesNo("Mapping","Do you want keep mappings.",function(q){if(q=="yes"){_metExploreViz.getMappingsSet().forEach(function(r){metExploreD3.GraphMapping.reloadMapping(r);metExploreD3.fireEventArg("selectMappingVisu","jsonmapping",r)});metExploreD3.fireEventArg("buttonRefresh","reloadMapping",true)}else{metExploreD3.fireEventArg("buttonMap","reloadMapping",false);metExploreD3.fireEventArg("buttonRefresh","reloadMapping",false);metExploreD3.fireEventArg("selectConditionForm","closeMapping",_metExploreViz.getActiveMapping);_metExploreViz.resetMappings()}})}if(n[o].mapped){m.setMapped(n[o].mapped)}if(n[o].mappingDataType){m.setMappingDataType(n[o].mappingDataType)}if(n[o].activeMapping){m.setActiveMapping(n[o].activeMapping)}}if(b.linkStyle){var f=new LinkStyle(b.linkStyle.size,b.linkStyle.lineWidth,b.linkStyle.markerWidth,b.linkStyle.markerHeight,b.linkStyle.markerInColor,b.linkStyle.markerOutColor,b.linkStyle.markerStrokeColor,b.linkStyle.markerStrokeWidth,b.linkStyle.strokeColor);metExploreD3.setLinkStyle(f)}if(b.metaboliteStyle){var f=new MetaboliteStyle(b.metaboliteStyle.height,b.metaboliteStyle.width,b.metaboliteStyle.rx,b.metaboliteStyle.ry,b.metaboliteStyle.fontSize,b.metaboliteStyle.strokeWidth,b.metaboliteStyle.label,b.metaboliteStyle.strokeColor);metExploreD3.setMetaboliteStyle(f)}if(b.reactionStyle){var f=new ReactionStyle(b.reactionStyle.height,b.reactionStyle.width,b.reactionStyle.rx,b.reactionStyle.ry,b.reactionStyle.label,b.reactionStyle.fontSize,b.reactionStyle.strokeColor,b.reactionStyle.strokeWidth);metExploreD3.setReactionStyle(f)}for(var o in n){metExploreD3.GraphNetwork.refreshSvg(o)}a()}}},initDataJSON:function(j,b){var k=metExploreD3.GraphUtils.decodeJSON(j);if(k){var h=_metExploreViz.getSessionById("viz");var c=h.getD3Data();_metExploreViz.resetOldCoodinates();c.getNodes().forEach(function(i){_metExploreViz.addOldCoodinates({id:i.getId(),x:i.x,px:i.px,y:i.y,py:i.py})});var d=h.getForce();if(d!=undefined){d.nodes([]);d.links([]);d.on("start",null);d.on("end",null);d.on("tick",null)}h.reset();h.setAnimated(true);var c=new NetworkData("viz");c.cloneObject(k);var a=c.getNodes();a.forEach(function(i){if(i.getBiologicalType()=="metabolite"){if(c.getCompartmentByName(i.getCompartment())==null){c.addCompartment(i.getCompartment())}}else{i.getPathways().forEach(function(l){if(c.getPathwayByName(l)==null){c.addPathway(l)}})}});c.setId("viz");_metExploreViz.setInitialData(_metExploreViz.cloneNetworkData(c));h.setD3Data(c);metExploreD3.GraphNetwork.refreshSvg("viz");var f=_metExploreViz.getOldCoodinates();if(f.length>0){var g=false;var e=0;while(e<f.length-1&&!g){if(c.getNodeById(f[e].id)!=undefined){g=true}e++}if(g&&!metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.displayMessageYesNo("Coodinates","Do you want keep node coordinates.",function(i){if(i=="yes"){var l=[];f.forEach(function(m){var n=c.getNodeById(m.id);if(n!=undefined){n.x=m.x;n.y=m.y;n.px=m.px;n.py=m.py;l.push(m.id)}});d3.select("#viz").select("#graphComponent").selectAll("g.node").filter(function(m){return l.indexOf(m.id)!=-1}).each(function(m){m.setLocked(!m.isLocked());m.fixed=m.isLocked()});d3.select("#viz").select("#graphComponent").selectAll("g.node").filter(function(m){return l.indexOf(m.id)!=-1}).each(function(m){_MyThisGraphNode.selection(m,"viz")})}})}}if(_metExploreViz.getMappingsLength()>0){_metExploreViz.getMappingsSet().forEach(function(i){metExploreD3.GraphMapping.reloadMapping(i);metExploreD3.fireEventArg("selectMappingVisu","jsonmapping",i)});metExploreD3.fireEventArg("buttonRefresh","reloadMapping",true)}}b()},initiateViz:function(a){d3.select("#viz").selectAll("#presentationViz, #presentationLogoViz").classed("hide",true);metExploreD3.fireEvent("viz","initiateviz");_metExploreViz.setLaunched(true);if(a=="D3"){metExploreD3.GraphNetwork.delayedInitialisation("viz")}},loadData:function(a){var b=_metExploreViz.getSessionById(a);return b}};